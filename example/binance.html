<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="../dist/chart.css" />
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      html,
      body {
        height: 100%;
        cursor: ne-resize;
      }
      #chart {
        position: absolute;
        left: 50%;
        height: 100%;
        width: 100%;
        transform: translate(-50%);
      }
    </style>
  </head>
  <body>
    <div id="chart"></div>
    <script src="./axios.js"></script>
    <script src="../dist/index.js"></script>
    <script>
      // Binance API example
      const http = axios.create({
        baseURL: "https://api.binance.com",
      })

      function getKline(endTime) {
        return new Promise((resolve) => {
          http
            .get(`/api/v3/klines?symbol=ETHUSDT&interval=1m&endTime=${endTime}`)
            .then(({ data }) => {
              let bars = data.map((item) => ({
                time: Number(item[0]),
                open: Number(item[1]),
                high: Number(item[2]),
                low: Number(item[3]),
                close: Number(item[4]),
                volume: Number(item[5]),
              }))
              resolve(bars)
            })
        })
      }

      const endTime = new Date().getTime()
      let chart
      getKline(endTime).then((bars) => {
        chart = new BigoChart({
          el: "#chart",
          bars,
          loadMore: async (endTime) => getKline(endTime),
        })
      })

      // SUBSCRIBE DATA
      const ws = new WebSocket("wss://stream.binance.com/stream")

      const msg = JSON.stringify({
        method: "SUBSCRIBE",
        params: ["ethusdt@aggTrade"],
        id: 1,
      })

      ws.onopen = () => {
        ws.send(msg)
      }

      ws.onmessage = (e) => {
        let data = JSON.parse(e.data)
        if (!data.data) return
        let time = data.data.T
        let close = Number(data.data.p)
        let volume = Number(data.data.q)
        chart.subscribeBars(close, volume, time)
      }
    </script>
  </body>
</html>
