<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>trade-chart demo</title>
  </head>
  <link rel="stylesheet" type="text/css" href="../dist/chart.css" />
  <style>
    * {
      padding: 0;
      margin: 0;
    }
    html,
    body {
      height: 100%;
      cursor: ne-resize;
    }
    #chart {
      position: absolute;
      left: 50%;
      height: 500px;
      width: 1000px;
      transform: translate(-50%);
    }
  </style>
  <body>
    <div id="chart"></div>
    <script src="./axios.js"></script>
    <script src="./md5.js"></script>
    <script src="./signApi.js"></script>
    <script src="../dist/index.js"></script>
    <script type="module">
      let page = 1
      let size = 350
      let data

      function getData(size, page) {
        let now = new Date().getTime()
        return axios.get(
          `http://m.devbbtest.com/kline/ethusdt/1.htm?time=&size=${size}&page=${page}&_=${now}&_version=20210423&_s=${MD5(
            `?time=&size=${size}&page=${page}&_=${now}&_version=20210423`
          )}`
        )
      }

      getData(size, page).then((res) => {
        data = res.data
        let bars = data.split("|").map((item) => {
          const [open, high, low, close, time] = item.split(",")
          return {
            high: high * 1,
            open: open * 1,
            low: low * 1,
            close: close * 1,
            time: time * 1,
          }
        })
        const chart = new window.QuoteChart({
          el: "#chart",
          bars,
          loadMore: async () => {
            page++
            let { data: newData } = await getData(size, page)
            newData = newData.split("|").map((item) => {
              const [open, high, low, close, time] = item.split(",")
              return {
                high: high * 1,
                open: open * 1,
                low: low * 1,
                close: close * 1,
                time: time * 1,
              }
            })
            return newData
          },
        })

        const msg = JSON.stringify({
          sub: "add",
          type: "five",
          topic: "ETH/USDT",
        })

        const ws = new WebSocket(
          `ws://47.242.25.96:10000/websocket/quote?_=${Date.now()}` +
            "&_s=" +
            MD5(`ws://47.242.25.96:10000/websocket/quote?_=${Date.now()}`)
        )
        ws.onopen = () => {
          ws.send(msg)
        }
        ws.onmessage = (e) => {
          if (e.data === "ok") return
          let data = JSON.parse(e.data)
          chart.subscribeBars(data.data.price * 1, 0, data.data.time * 1)
        }
      })
    </script>
  </body>
</html>
